<Project>

    <PropertyGroup>
        <FSharpAnalyzers_ExeHost Condition="'$(FSharpAnalyzers_ExeHost)' == ''">dotnet</FSharpAnalyzers_ExeHost>
        <FSharpAnalyzers_Exe Condition="'$(FSharpAnalyzers_Exe)' == ''">fsharp-analyzers</FSharpAnalyzers_Exe>
        <FSharpAnalyzers_ContinueOnError Condition="'$(FSharpAnalyzers_ContinueOnError)' == ''">true</FSharpAnalyzers_ContinueOnError>
        <_FSharpAnalyzers_ProjectOptions>--project &quot;$(MSBuildProjectFile)&quot;</_FSharpAnalyzers_ProjectOptions>
    </PropertyGroup>

    <Target Name="_AnalyzeFSharpProject">
        <Error Condition="$(FSharpAnalyzersOtherFlags) == ''" Text="A property FSharpAnalyzersOtherFlags should exists with all the analyzer cli arguments!" />
        <Exec
                ContinueOnError="$(FSharpAnalyzers_ContinueOnError)"
                IgnoreExitCode="true"
                Command="$(FSharpAnalyzers_ExeHost) $(FSharpAnalyzers_Exe) $(_FSharpAnalyzers_ProjectOptions) $(FSharpAnalyzersOtherFlags)" />
    </Target>

    <Target Name="AnalyzeFSharpProject" DependsOnTargets="_AnalyzeFSharpProject" />

    <Target Name="_SetupFSharpAnalyzerProjectOptions" BeforeTargets="CoreCompile" Condition="'$(RunAnalyzers)' == 'true'">
        <PropertyGroup>
            <!-- 
                Required for F# Targets CoreCompile to output command line arguments 
                https://github.com/dotnet/fsharp/blob/53929f2e01281a614a15033dfaae6fb6d00bb543/src/FSharp.Build/Fsc.fs#L721-L725 
                https://github.com/dotnet/fsharp/blob/53929f2e01281a614a15033dfaae6fb6d00bb543/src/FSharp.Build/Microsoft.FSharp.Targets#L418C19-L418C32
            -->
            <ProvideCommandLineArgs>true</ProvideCommandLineArgs>
        </PropertyGroup>
    </Target>

    <Target 
        Name="_FSharpAnalyzerAfterBuild" 
        DependsOnTargets="_SetupFSharpAnalyzerProjectOptions;CoreCompile" 
        AfterTargets="AfterBuild" 
        Condition="'$(RunAnalyzers)' == 'true'">
        <Error Condition="$(FSharpAnalyzersOtherFlags) == ''" Text="A property FSharpAnalyzersOtherFlags should exists with all the analyzer cli arguments!" />
        <PropertyGroup>
            <FSharpAnalyzers_AlwaysRunAfterBuild Condition="$(FSharpAnalyzers_AlwaysRunAfterBuild) == '' and '@(FscCommandLineArgs->Count())' != '0'">true</FSharpAnalyzers_AlwaysRunAfterBuild>
            <_FSharpAnalyzers_ProjectOptions Condition="'@(FscCommandLineArgs->Count())' != '0'">--fsc-args &quot;@(FscCommandLineArgs)&quot;</_FSharpAnalyzers_ProjectOptions>
        </PropertyGroup>
        <Exec
                ContinueOnError="$(FSharpAnalyzers_ContinueOnError)"
                Condition="'$(FSharpAnalyzers_AlwaysRunAfterBuild)' == 'true'"
                Command="$(FSharpAnalyzers_ExeHost) $(FSharpAnalyzers_Exe) $(_FSharpAnalyzers_ProjectOptions) $(FSharpAnalyzersOtherFlags)" />
    </Target>

    <Target Name="FSharpAnalyzerAfterBuild" DependsOnTargets="_FSharpAnalyzerAfterBuild"/>
</Project>